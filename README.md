# Тестовое задание для стажера-разработчика

Реализовать сервис, предоставляющий API по созданию сокращённых ссылок.

Ссылка должна быть:
* Уникальной; на один оригинальный URL должна ссылаться только одна сокращенная ссылка;
* Длиной 10 символов;
* Из символов латинского алфавита в нижнем и верхнем регистре, цифр и символа _ (подчеркивание).

Сервис должен быть написан на Go и принимать следующие запросы по http:
1. Метод Post, который будет сохранять оригинальный URL в базе и возвращать сокращённый.
2. Метод Get, который будет принимать сокращённый URL и возвращать оригинальный.


***Условие со звёздочкой (будет большим плюсом)***:
* Сделать работу сервиса через GRPC, то есть составить proto и реализовать сервис с двумя соответствующими эндпойнтами


Решение должно соответствовать условиям:
* Сервис распространён в виде Docker-образа;
* В качестве хранилища ожидаем in-memory решение и PostgreSQL. Какое хранилище использовать, 
  указывается параметром при запуске сервиса;
* Реализованный функционал покрыт Unit-тестами.

Результат предоставить в виде публичного репозитория на github.com

## Вопросы и ответы по заданию

### Какие методы сделать идемпотентными в API?

По логике работы команд `SET`, `GET`, `DEL` в Redis, они являются идемпотентными. Соответственно, и на уровне API
они также останутся идемпотентными. Для остальных методов каждый вызов будет изменять состояние в хранилище. Поэтому
эти методы сами по себе не являются идемпотентными. 

Для превращения их в идемпотентные методы на уровне API можно реализовать дополнительный контроллер принимающий от пользователя, 
сгенерированный им, id запроса, с помощью которого контроллер будет определять является ли запрос повторным или нет и, 
соответственно, решать выполнять эту команду или вернуть результат уже выполненной. Но такое решение усложнит веб сервис.
Поэтому при условии, что явно не требуется идемпотентность данных методов, решено остановиться на идемпотентности только
трёх методов: `SET`, `GET`, `DEL`.

### Какие реализовать обработку команд в одном потоке, при этом получать HTTP запросы параллельно? (на основе пунтка "Сервис должен принимать команды по HTTP параллельно, обрабатывать все команды необходимо в одном потоке.")

Было решено сделать объект `Reducer`, который бы запускал в отдельной горутине и обрабатывал передаваемые через канал
от клиента данные. А также возвращал бы через каналы клиенту результат или ошибку.

## Общее описание решения

- Сервис реализован на языке `Golang` версии `1.22`.
- В качестве web фреймворка используется [gin](https://github.com/gin-gonic/gin).
- Логирование операций в файл в папку `/app-log`, настраиваемое в файле конфигураций.
- Реализованы `Middlewares` для: отслеживания паники, логирования.
- Сервис поднимается в `Docker` контейнерах: хранилища Redis, основное приложение.
- Контейнеры конфигурируются в  `docker-compose`. Для сборки сервиса используется multi-stage сборка в `Docker`.
- В качестве СУБД используется `PostgreSQL`. В качестве библиотеки для работы с запросами к `PostgreSQL` используется
  [pgxpool](https://github.com/jackc/pgx).
- API задокументировано с использованием Swagger по адресу `http://localhost:8080/api/v1/swagger/`. 
  Файл с API находится в папке docs.
- Все методы имеют префикс `/api/v1`.
- Взаимодействие с проектом организовано посредством `Makefile`.
- Тесты реализованы с помощью библиотеки [allure-go](https://github.com/ozontech/allure-go).
- Подключен `Github Actions` для проверки стиля, тестирования и сборки приложения.

## Инструкция по запуску:

### Исполняемый файл сервиса mini-godis

Описание аргументов командной строки при работе с исполняемым файлом сервиса баннеров.

***Использование:***
```bash
server [-c=<file> | --config=<file>] [-h | --help]
````

***Опции:***
```bash
   -c --config=<file> - путь к файлу с конфигурациями (по умолчанию путь до локальной конфигурации (./configs/localhsot-config.yaml)).
   -h --help - выводит список допустимых опций и их описание.
```

### Конфигурационный файл

Все конфигурационные файлы находятся в папке `config`. Файлы `docker-config.yaml` и `localhost-config.yaml` 
являются файлами конфигурации сервиса для запуска в боевом окружении в Docker и для локального запуска вне Docker контейнера.

Конфигурационный файл имеет следующие поля:
```yaml
port: 8080 # Порт на котором запускается сервер
mode: release # Режим запуска системы
redis:  # Настройки подключения к Redis
   url: "redis://chaches/0" # Строка подключения к хранилищу Redis
logger: # Настройки логгера
   app_name: "mini-godis" # Имя приложения, будет выводиться в лог
   level: 'info'  # Минимальный уровень вывода информации в лог
   directory: './app-log/' # Папка куда сохранять логи
   use_std_and_file: false # Если установлено в true, то лог будет выводиться как в файл так и в stdErr
   allow_show_low_level: false # Если установлено в true и use_std_and_file тоже true, то в stdErr будет выводиться лог всех уровней
```

Существует четыре режима работы:
* `release` -- Запуск в режиме релиза (влияет на запуск gin в режиме Release).
* `debug` -- Запуск в режиме отладки (влияет на запуск gin в режиме Debug).
* `debug+prof` -- Запуск как в режиме `debug`, но с подключением профилирования.
* `release+prof` -- Запуск как в режиме `release`, но с подключением профилирования.

**Все поля обязательны.**

### Сборка контейнера с веб-сервисом

Теперь необходимо собрать докер образ с веб-сервисом:

```bash
make build-docker
```

После запуска команды на сборку докер образа появятся образ `mini-godis`, который поддерживает env переменную 
`CONFIG_PATH`, которая позволяет установить путь до конфигурационного файла в аргумент `--config` запускаемого сервиса.

### Запуск всей системы

Для запуска необходимо выполнить следующую команду:

```bash
make run
```

Если необходимо запустить docker-compose не в режиме демона, то можно выполнить следующую команду:

```bash
make run-verbose
```

Система запущена. Сервер доступен на http://localhost:8080/.

Api можно посмотреть и запускать на http://localhost:8080/api/v1/swagger/index.html.

### Остановка

Для остановки с сохранением контейнеров необходимо выполнить следующую команду:

```bash
make stop
```

Для полной остановки необходимо выполнить следующую команду:

```bash
make down
```

### Дополнительно

#### Тесты

Дополнительно были реализованы юнит-тесты на основные элементы сервиса. Для их запуска следует выполнить следующую команду:

```bash
maker run-tests
```
Для тестов использовалась библиотека [allure-go](https://github.com/ozontech/allure-go), которая генерирует отчёт по 
выполненным тестам. Для его просмотра необходим выполнить следующую команду

```bash
make run-report
```

Отчёты можно очистить с помощью команды:

```bash
make clear-reports
```

![Пример отчёта](img.png)

Для запуска тестов с расчётом покрытия необходимо выполнить команду:

```bash
make run-coverage
```

#### Линтеры

Была собрана конфигурация линтера в файле `.golangci.yml` для утилиты [golangci-lint](https://golangci-lint.run/).
Для запуска проверки линтера необходимо запустить команду:

```bash
golangci-lint run
```
Предварительно `golangci-lint` необходимо установить.
